<template>
<div class="container mt-3">
  <div class="row">
    <div class="col-md-9">
      <h2>My experiments</h2>
      <p v-if="total.running != undefined">
        <span class="badge badge-pill badge-success">{{total.running}}</span> Running
        <span class="badge badge-pill badge-warning">{{total.upcoming}}</span> Scheduled
        <span class="badge badge-pill badge-dark">{{total.terminated}}</span> Completed
      </p>
      <p v-else>
        <span class="badge badge-pill badge-success">?</span> Running
        <span class="badge badge-pill badge-warning">?</span> Scheduled
        <span class="badge badge-pill badge-dark">?</span> Completed
      </p>
      <experiment-list ref="runningExpList" title="Scheduled" user="@self" state="all_scheduled" @completed="updateTotal"></experiment-list>
      <p>
        <router-link :to="{name:'experiment'}" class="btn btn-primary">New experiment</router-link>
      </p>
      <template v-if="total.terminated">
        <experiment-list title="Recent" user="@self" state="all_terminated" :show="5" :total="total.terminated" @started="refreshRunning" @loaded="spinner = false"></experiment-list>
      </template>
      <template v-if="spinner">
        <i class="fa fa-spinner fa-spin fa-fw"></i>
        <i>loading experiments</i>
      </template>
      
    </div>
    <div class="col">
      <h2>Platform status</h2>
      <p v-if="sites">
        <span class="badge badge-pill mr-1 cursor" :class="{'badge-primary': currentSite === 'all', 'badge-secondary': currentSite !== 'all'}"
        @click="currentSite = 'all'">{{sites.length}} sites</span>
        <span v-for="site in sites" class="badge badge-pill mr-1 cursor" :class="{'badge-primary': currentSite === site, 'badge-secondary': currentSite !== site}"
        @click="currentSite = site">{{site.site}}</span>
      </p>
      <p v-if="nodes">
        <span class="badge badge-pill badge-success">{{getNodesCount(currentSite, ['Alive'])}}</span> nodes available
        <span class="badge badge-pill badge-warning">{{getNodesCount(currentSite, ['Busy'])}}</span> busy
        <span class="badge badge-pill badge-danger">{{getNodesCount(currentSite, ['Absent','Suspected','Dead'])}}</span> unavailable
      </p>
      <p v-else>
        <i class="fa fa-spinner fa-spin fa-fw"></i>
      </p>
      <p v-if="runningExps">
        <router-link :to="{name:'runningExperiments'}" class="btn btn-light">Running experiments
          <span class="badge badge-pill badge-dark">{{getRunningCount(currentSite)}}</span>
        </router-link>
      </p>
    </div>
  </div>

</div> <!-- container -->

</template>

<script>
import ExperimentList from '@/components/ExperimentList'
import {iotlab} from '@/rest'
import {auth} from '@/auth'
// import { sleep } from '@/utils'

export default {
  name: 'Dashboard',

  components: {ExperimentList},

  data () {
    return {
      total: {},
      sites: [],
      nodes: [],
      runningExps: [],
      experiments: [],
      currentSite: 'all',
      auth: auth,
      started: 0,
      spinner: true,
    }
  },

  beforeRouteEnter (to, from, next) {
    // refresh data when reentering the dashboard
    next(vm => {
      if (vm.sites.length === 0) return // do not refresh until initial render as be done in created()
      vm.$notify({group: 'popup', clean: true})
      vm.$refs.runningExpList.refresh()
      vm.$refs.runningExpList.createPolling()
      vm.updateTotal()
    })
  },

  beforeRouteLeave (to, from, next) {
    // Indicate to the SubComponent to stop experiments polling
    this.$refs.runningExpList.destroyPolling()
    // Make sure to always call the next function, otherwise the hook will never be resolved
    // Ref: https://router.vuejs.org/en/advanced/navigation-guards.html
    next()
  },

  created () {
    this.updateTotal()
    iotlab.getSites().then(data => { this.sites = data })
    iotlab.getNodes().then(data => { this.nodes = data })
    iotlab.getRunningExperiments().then(data => { this.runningExps = data })
  },

  async mounted () {
    this.$notify({group: 'popup', clean: true})
    let user = await iotlab.getUserInfo()
    if (!user.category) {
      this.$notify({group: 'popup', type: 'fill-user-profile'})
    }
  },

  methods: {
    async updateTotal () {
      iotlab.getNodes().then(data => { this.nodes = data })
      iotlab.getRunningExperiments().then(data => { this.runningExps = data })
      // await sleep(2000)
      this.total = await iotlab.getUserExperimentsCount()
      // hide spinner as we are not going to fetch terminated experiments
      if (this.total.terminated === 0) this.spinner = false
    },
    refreshRunning () {
      this.$refs.runningExpList.refresh()
      iotlab.getNodes().then(data => { this.nodes = data })
      iotlab.getRunningExperiments().then(data => { this.runningExps = data })
    },
    getNodesCount (site, stateList) {
      let siteList = (site === 'all') ? this.sites.map(key => key.site) : [site.site]
      return this.nodes.filter(node => siteList.includes(node.site)).filter(node => stateList.includes(node.state)).length
    },
    getRunningCount (site) {
      return this.runningExps.filter(xp => site === 'all' || xp.nodes.some(node => node.includes(site.site))).length
    },
  },

}
</script>
